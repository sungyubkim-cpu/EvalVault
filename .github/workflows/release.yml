name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    concurrency: release
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Install semantic-release
        run: uv pip install python-semantic-release

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get next version
        id: version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current version from pyproject.toml
          CURRENT_VERSION=$(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT

          # Check if there's a new version to release (based on conventional commits)
          NEXT_VERSION=$(uv run semantic-release version --print 2>/dev/null || echo "")

          # Check if tag already exists
          if [ -n "$NEXT_VERSION" ]; then
            if git rev-parse "v${NEXT_VERSION}" >/dev/null 2>&1; then
              echo "Tag v${NEXT_VERSION} already exists, skipping release"
              echo "should_release=false" >> $GITHUB_OUTPUT
            elif [ "$NEXT_VERSION" != "$CURRENT_VERSION" ]; then
              echo "next_version=${NEXT_VERSION}" >> $GITHUB_OUTPUT
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "Next version will be: $NEXT_VERSION"
            else
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "No new version to release (current: $CURRENT_VERSION)"
            fi
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "No version determined by semantic-release"
          fi

      - name: Create release tag
        if: steps.version.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.version.outputs.next_version }}"
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"

      - name: Build package with new version
        if: steps.version.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.version.outputs.next_version }}"
          # Update version in pyproject.toml for build (not committed)
          sed -i "s/^version = \".*\"/version = \"${VERSION}\"/" pyproject.toml
          uv build

      - name: Publish to PyPI
        if: steps.version.outputs.should_release == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

      - name: Create GitHub Release
        if: steps.version.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.next_version }}"
          gh release create "v${VERSION}" dist/* \
            --title "v${VERSION}" \
            --generate-notes
